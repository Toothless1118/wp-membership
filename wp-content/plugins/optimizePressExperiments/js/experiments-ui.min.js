!function(a){a(document).ready(function(){function b(){var b=[],c=this;this.init=function(){this._initEvents()},this._initEvents=function(){a(document).on("click",".op-experiments-new-variant",this.newVariant),a(document).on("click",".op-experiments-new-clone-variant",this.cloneOriginal),a(document).on("click",".op-experiments-variant-delete",this.removeVariant),a(".op-experiments-stats-main-content").on("click",".op-experiments-edit",this.editExperimentForm),a(".op-experiments-edit-experiment").on("click",this.editExperimentForm),a(".op-experiments-stats-main-content").on("click",".op-experiments-new-experiment",this.createExperimentForm),a("#op-pagebuilder-container").on("click",".op-experiments-new-experiment",this.createExperimentForm),a(document).on("click",".op-experiments-save-experiment",this.saveExperiment),a(".op-experiments-stats-main-content").on("click",".op-experiments-switch-status",this.switchExperimentStatus),a("#op-pagebuilder-container").on("click",".op-experiments-switch-status",this.switchExperimentStatus),a(".op-experiments-stats-main-content").on("click",".op-delete-experiment",this.deleteExperiment),a(document).on("change","#op_sections_experiments_goal_type",this.toggleGoalTypeFields),a(document).on("experiments:taken","#op-experiments-experiment-form",this.disableSelectedPages)},this.disableSelectedPages=function(c,d,e){var f=a(".op-experiments-original-page-autocomplete, #op_sections_experiments_goal_page, .op-experiments-variant-page-autocomplete").not(d).filter(":visible");f.find("option").attr("disabled",!1),b.length>0&&f.find("option").filter(function(c){return a.inArray(a(this).attr("value"),b)>=0&&"selected"!==a(this).attr("selected")}).attr("disabled",!0),f.select2({placeholder:OPSE.l10n.select_page})},this.bindAutoComplete=function(c,d){d="undefined"==typeof d||d;var e="";d===!1&&(e="&no-filter=1");var f=a("#op_sections_experiments_experiment_id").val();a.ajax({url:OptimizePress.ajaxurl+"?action=op-experiments-page-list&experiment_id="+f+e,type:"GET",dataType:"json"}).then(function(d){a.each(d.data,function(b,d){c.append(a("<option></option>").attr("value",d.id).text(d.text))}),c.find("option").attr("disabled",!1),b.length>0&&c.find("option").filter(function(c){return a.inArray(a(this).attr("value"),b)>=0&&a(this).attr("value")!==a(this).parent().prev().val()}).attr("disabled",!0),c.select2({placeholder:OPSE.l10n.select_page}).on("select2:selecting",function(c){var d=c.currentTarget.value;if(""!==d){var e=a.inArray(d,b);e>=0&&b.splice(e,1)}}).on("select2:select",function(c){b.push(c.currentTarget.value),a("#op-experiments-experiment-form").trigger("experiments:taken",[c.currentTarget,c.currentTarget.value]),a(c.currentTarget).prev().val(c.params.data.id)}).on("change",function(b){""!==b.currentTarget.value&&a(b.currentTarget).find("option[value="+b.currentTarget.value+"]").attr("selected",!0)}),c.each(function(){a(this).val(a(this).prev().val()).trigger("change")})})},this.initDateRangePicker=function(b){return a(b).dateRangePicker({autoClose:!0,singleDate:!0,showShortcuts:!1,singleMonth:!0,startDate:moment().format("YYYY-MM-DD")})},this.newVariant=function(b){var d=a(".op-experiments-variant:last").clone();return d.find("input").val(""),d.find(".select2").remove(),c.bindAutoComplete(d.find(".op-experiments-variant-page-autocomplete")),a(".op-experiments-variants").append(d),!1},this.cloneOriginal=function(b){var d=a("#op_sections_experiments_original_page_id").val();return c.clonePage(d).then(function(b){var d=a("#op-experiments-experiment-form .op-experiments-variant:last"),e=a("#op-experiments-experiment-form .op-experiments-variant").length;""!==d.find(".op-experiments-page-id").val()&&(c.newVariant([]),d=a("#op-experiments-experiment-form .op-experiments-variant:last"),e+=1),c._fillVariantFields(d,{name:"Variation #"+e,page_title:b.data.title,page_id:b.data.id})}),!1},this.getPage=function(b){return a.ajax({url:OptimizePress.ajaxurl+"?action=op-experiments-get-page",type:"GET",data:{page_id:b},dataType:"json"})},this.clonePage=function(b){return a.ajax({url:OptimizePress.ajaxurl+"?action=op-experiments-clone-page",type:"GET",data:{page_id:b},dataType:"json"})},this.removeVariant=function(b){return a(".op-experiments-variant").length>1?a(b.currentTarget).parent().remove():a(".op-experiments-variant:last").find("input").val(""),!1},this.createExperimentForm=function(d){var e=wp.template("op-experiment-edit");b=[],a.fancybox(a.extend({},OptimizePress.fancybox_defaults,{minWidth:400,content:e({form_title:"New experiment",container_class:"op-new-experiment",action_label:"Create"})})),a(".fancybox-inner #op_sections_experiments_goal_type").trigger("change"),c.bindAutoComplete(a(".fancybox-inner .op-experiments-original-page-autocomplete, .fancybox-inner .op-experiments-variant-page-autocomplete"));c.initDateRangePicker("#op_sections_experiments_start_date"),c.initDateRangePicker("#op_sections_experiments_end_date");return a(this).attr("data-page-id")&&c.getPage(a(this).attr("data-page-id")).then(function(b){return b.success===!1?void alert(b.data.message):(a("#op_sections_experiments_original_page").val(b.data.title),void a("#op_sections_experiments_original_page_id").val(b.data.id))}),!1},this.editExperimentForm=function(d){var e=a(this).attr("data-experiment-id")||a(this).parents("tr").attr("data-experiment-id"),f=wp.template("op-experiment-edit");b=[],a.fancybox(a.extend({},OptimizePress.fancybox_defaults,{minWidth:400,content:f({form_title:"Edit experiment",container_class:"op-edit-experiment",action_label:"Update"})})),a("#op_sections_experiments_experiment_id").val(e);c.initDateRangePicker("#op_sections_experiments_start_date"),c.initDateRangePicker("#op_sections_experiments_end_date");return c.getExperiment(e).then(function(d){if(d.success===!1)return void alert(d.data.message);var e=d.data.experiment,f=d.data.variations;a("#op_sections_experiments_experiment_status").val(e.status),a("#op_sections_experiments_experiment_name").val(e.name),a("#op_sections_experiments_start_date").val(e.start_date),a("#op_sections_experiments_end_date").val(e.end_date),a("#op_sections_experiments_original_page").val(e.page_id),a("#op_sections_experiments_original_page_id").val(e.page_id),a("#op_sections_experiments_goal_type").val(e.goal_type).trigger("change"),a("#op_sections_experiments_goal_page").val(e.goal_page_id),a("#op_sections_experiments_goal_page_id").val(e.goal_page_id),b.push(e.page_id),b.push(e.goal_page_id),c.bindAutoComplete(a(".fancybox-inner .op-experiments-original-page-autocomplete")),a.each(f,function(d,e){0!==d&&c.newVariant(),b.push(e.page_id),c._fillVariantFields(a("#op-experiments-experiment-form .op-experiments-variant:last"),e)})}),!1},this.getExperiment=function(b){return a.ajax({url:OptimizePress.ajaxurl+"?action=op-experiments-get-experiment",type:"GET",data:{experiment_id:b},dataType:"json"})},this.saveExperiment=function(b){var d=[],e=a("#op_sections_experiments_experiment_status").val(),f=a("#op_sections_experiments_end_date").val(),g=a("#op_sections_experiments_goal_type").val(),h=a("#op_sections_experiments_start_date").val(),i=a("#op_sections_experiments_goal_page_id").val(),j=a("#op_sections_experiments_experiment_id").val(),k=a("#op_sections_experiments_experiment_name").val(),l=a("#op_sections_experiments_original_page_id").val();return a(".op-experiments-variant").each(function(b,c){d.push({id:a(c).find('input[name*="variation_page_id"]').val(),label:a(c).find('input[name*="variation_label"]').val()})}),a.ajax({url:OptimizePress.ajaxurl+"?action=op-experiments-save-experiment",type:"POST",data:{status:e,end_date:f,goal_type:g,start_date:h,variations:d,goal_page_id:i,experiment_id:j,experiment_name:k,original_page_id:l},success:function(b){c.resetTheForm(a("#op-experiments-experiment-form")),a(".op-experiments-stats-main-content").length?c._updateExperimentRow({status:e,end_date:f,goal_type:g,start_date:h,experiment_id:b.data.experiment_id,experiment_name:k,original_page_id:l,original_page_url:b.data.original_page_url,original_page_title:b.data.original_page_title}):(a(".op-experiments-new-experiment").hide(),a(".op-experiments-edit-experiment").show().attr("data-experiment-id",b.data.experiment_id),c._updateExperimentStatusButton(b.data.experiment_id,e,a(".op-experiments-switch-status")),a(".op-experiments-experiment-status").show()),OptimizePress.disable_alert=!0,a.fancybox.close(),OptimizePress.disable_alert=!1},dataType:"json"}),!1},this.deleteExperiment=function(b){if(confirm(OPSE.l10n.are_you_sure_you_want_to_delete_experiment)){var d=a(this).parents("tr"),e=d.attr("data-experiment-id");c.removeExperiment(e).then(function(b){b.success!==!1&&(d.remove(),c._decrementRowspan(),a("#op-experiment-charts-"+e).remove(),a("#op-experiments-table tbody tr").length<1?(a("#op-experiments-table, #op-experiment-stats").remove(),a(".op-experiments-stats-main-content").append(wp.template("op-experiment-no-experiments")())):0===a("#op-experiments-table .op-experiments-new-experiment").length&&a("#op-experiments-table tbody tr").first().append('<td rowspan="'+a("#op-experiments-table tr").length+'">'+wp.template("op-experiment-add")()+"</td>"),a("#op-experiment-stats .cf").remove(),a(".op-experiment-overview:odd").after('<div class="cf"></div>'))})}return!1},this.removeExperiment=function(b){return a.ajax({url:OptimizePress.ajaxurl+"?action=op-experiments-remove-experiment",type:"GET",data:{experiment_id:b},dataType:"json"})},this.switchExperimentStatus=function(b){var d=a(this).parents("tr"),e=a(this).attr("data-experiment-id"),f=parseInt(a(this).attr("data-status")),g=0;return 0===f&&(g=2),a.ajax({url:OptimizePress.ajaxurl+"?action=op-experiments-switch-status",type:"POST",data:{experiment_id:e,status:g},success:function(f){f.success===!0&&(a(b.currentTarget).hasClass("op-experiment-status-icon")?c._updateExperimentStatusUi(e,g,d):c._updateExperimentStatusButton(e,g,a(b.currentTarget)))},dataType:"json"}),!1},this.resetTheForm=function(a){a.find("input").val(""),a.find("op-experiments-variant:not(:first)").remove()},this.toggleGoalTypeFields=function(b){"optin"===a(this).val()?(a(".op-experiment-goal-visit").hide(),a("#op_sections_experiments_goal_page").data("select2")&&a("#op_sections_experiments_goal_page").select2("destroy")):(a(".op-experiment-goal-visit").show(),c.bindAutoComplete(a("#op_sections_experiments_goal_page"),!1))},this._updateExperimentStatusUi=function(a,b,c){var d=c.find(".op-experiments-experiment-status-label"),e=c.find(".op-experiments-experiment-status-button"),f=2===parseInt(b)?"Live":"Paused";d.html('<span class="op-experiment-status-'+b+'" data-status="'+b+'" data-experiment-id="'+a+'">'+f+"</span>"),e.html('<a href="#switch-experiment-status" class="op-experiments-switch-status op-experiment-status-icon op-experiment-status-icon-'+b+'" data-experiment-id="'+a+'" data-status="'+b+'"></a>')},this._updateExperimentStatusButton=function(a,b,c){var d=2===parseInt(b)?"Live":"Paused",e=2===parseInt(b)?"dashicons-controls-pause":"dashicons-controls-play";c.attr("data-experiment-id",a).attr("data-status",b).html(d+'<span class="dashicons '+e+'"></span>')},this._updateExperimentRow=function(b){var c=wp.template("op-experiment-row"),d=a('#op-experiments-table tr[data-experiment-id="'+b.experiment_id+'"]');d.length?(d.replaceWith(c(b)),this._updateExperimentStatusUi(b.experiment_id,b.status,a('#op-experiments-table tr[data-experiment-id="'+b.experiment_id+'"]'))):a("#op-experiments-table").length?(a("#op-experiments-table tbody").append(c(b)),this._updateExperimentStatusUi(b.experiment_id,b.status,a('#op-experiments-table tr[data-experiment-id="'+b.experiment_id+'"]')),this._incrementRowspan()):(this._addExperimentTable(),a("#op-experiments-table tbody").append(c(b)),this._updateExperimentStatusUi(b.experiment_id,b.status,a('#op-experiments-table tr[data-experiment-id="'+b.experiment_id+'"]')),a('#op-experiments-table tr[data-experiment-id="'+b.experiment_id+'"]').append('<td rowspan="1">'+wp.template("op-experiment-add")()+"</td>"))},this._incrementRowspan=function(){var b=a("#op-experiments-table td[rowspan]");b.attr("rowspan",parseInt(b.attr("rowspan"))+1)},this._decrementRowspan=function(){var b=a("#op-experiments-table td[rowspan]");b.attr("rowspan",parseInt(b.attr("rowspan"))-1)},this._addExperimentTable=function(){a(".op-experiments-stats-main-content").html(wp.template("op-experiment-table")())},this._fillVariantFields=function(a,b){a.find(".op-experiments-page-label").val(b.name),a.find(".op-experiments-variant-page-autocomplete").val(b.page_id),a.find(".op-experiments-page-id").val(b.page_id),a.find(".select2").remove(),c.bindAutoComplete(a.find(".op-experiments-variant-page-autocomplete"))}}var c=new b;c.init()})}(opjq);