tinymce.PluginManager.add("link",function(a){function b(b){return function(){var c=a.settings.link_list;"string"==typeof c?tinymce.util.XHR.send({url:c,success:function(a){b(tinymce.util.JSON.parse(a))}}):b(c)}}function c(b){function c(a){var b=l.find("#text");(!b.value()||a.lastControl&&b.value()==a.lastControl.text())&&b.value(a.control.text()),l.find("#href").value(a.control.value())}function d(){var c=[{text:"None",value:""}];return tinymce.each(b,function(b){c.push({text:b.text||b.title,value:a.convertURL(b.value||b.url,"href"),menu:b.menu})}),c}function e(b){var c=[{text:"None",value:""}];return tinymce.each(a.settings.rel_list,function(a){c.push({text:a.text||a.title,value:a.value,selected:b===a.value})}),c}function f(b){var c=[{text:"None",value:""}];return a.settings.target_list||c.push({text:"New window",value:"_blank"}),tinymce.each(a.settings.target_list,function(a){c.push({text:a.text||a.title,value:a.value,selected:b===a.value})}),c}function g(b){var d=[];return tinymce.each(a.dom.select("a:not([href])"),function(a){var c=a.name||a.id;c&&d.push({text:c,value:"#"+c,selected:-1!=b.indexOf("#"+c)})}),d.length?(d.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:d,onselect:c}):void 0}function h(){m&&m.value(a.convertURL(this.value(),"href")),k||0!==p.text.length||this.parent().parent().find("#text")[0].value(this.value())}var i,j,k,l,m,n,o,p={},q=a.selection,r=a.dom;i=q.getNode(),j=r.getParent(i,"a[href]"),p.text=k=j?j.innerText||j.textContent:q.getContent({format:"text"}),p.href=j?r.getAttrib(j,"href"):"",p.target=j?r.getAttrib(j,"target"):"",p.rel=j?r.getAttrib(j,"rel"):"","IMG"==i.nodeName&&(p.text=k=" "),b&&(m={type:"listbox",label:"Link list",values:d(),onselect:c,value:a.convertURL(p.href,"href"),onPostRender:function(){m=this}}),a.settings.target_list!==!1&&(o={name:"target",type:"listbox",label:"Target",values:f(p.target)}),a.settings.rel_list&&(n={name:"rel",type:"listbox",label:"Rel",values:e(p.rel)}),l=a.windowManager.open({title:"Insert link",data:p,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:h,onkeyup:h},{name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){p.text=this.value()}},g(p.href),m,n,o],onSubmit:function(b){function c(b,c){var d=a.selection.getRng();window.setTimeout(function(){a.windowManager.confirm(b,function(b){a.selection.setRng(d),c(b)})},0)}function d(){e.text!=k?j?(a.focus(),j.innerHTML=e.text,r.setAttribs(j,{href:f,target:e.target?e.target:null,rel:e.rel?e.rel:null}),q.select(j)):a.insertContent(r.createHTML("a",{href:f,target:e.target?e.target:null,rel:e.rel?e.rel:null},e.text)):a.execCommand("mceInsertLink",!1,{href:f,target:e.target,rel:e.rel?e.rel:null})}var e=b.data,f=e.href;return f?f.indexOf("@")>0&&-1==f.indexOf("//")&&-1==f.indexOf("mailto:")?void c("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(a){a&&(f="mailto:"+f),d()}):/^\s*www\./i.test(f)?void c("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(a){a&&(f="http://"+f),d()}):void d():void a.execCommand("unlink")}})}function d(b,c){function d(a){var b=new tinymce.util.Color(a),c=b.toRgb();f.fromJSON({r:c.r,g:c.g,b:c.b,hex:b.toHex().substr(1)}),e(b.toHex())}function e(a){f.find("#preview")[0].getEl().style.background=a}var f=a.windowManager.open({title:"Color",items:{type:"container",layout:"flex",direction:"row",align:"stretch",padding:5,spacing:10,items:[{type:"colorpicker",value:c,onchange:function(){var a=this.rgb();f&&(f.find("#r").value(a.r),f.find("#g").value(a.g),f.find("#b").value(a.b),f.find("#hex").value(this.value().substr(1)),e(this.value()))}},{type:"form",padding:0,labelGap:5,defaults:{type:"textbox",size:7,value:"0",flex:1,spellcheck:!1,onchange:function(){var a,b,c=f.find("colorpicker")[0];return a=this.name(),b=this.value(),"hex"==a?(b="#"+b,d(b),void c.value(b)):(b={r:f.find("#r").value(),g:f.find("#g").value(),b:f.find("#b").value()},c.value(b),void d(b))}},items:[{name:"r",label:"R",autofocus:1},{name:"g",label:"G"},{name:"b",label:"B"},{name:"hex",label:"#",value:"000000"},{name:"preview",type:"container",border:1}]}]},onSubmit:function(){b("#"+this.toJSON().hex)}});d(c)}a.settings.color_picker_callback||(a.settings.color_picker_callback=d),a.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:b(c),stateSelector:"a[href]"}),a.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),a.addShortcut("Ctrl+K","",b(c)),this.showDialog=c,a.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:b(c),stateSelector:"a[href]",context:"insert",prependToContext:!0})});